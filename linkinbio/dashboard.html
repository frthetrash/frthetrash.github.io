<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | LinkShare</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base Theme: Deep Charcoal & High Contrast */
        body { 
            background-color: #121212; /* Deep Charcoal Black */
            color: #F8FAFC; /* Near-white text */
            font-family: ui-sans-serif, system-ui;
            opacity: 0; 
            transition: opacity 0.5s;
        }

        /* Accent Color: Neon Blue */
        .neon-blue {
            color: #00BFFF; /* Deep Sky Blue */
        }
        .neon-bg {
            background-color: #00BFFF; 
        }
        
        /* Card/Panel Styling (Crisp, High-Contrast Cards) */
        .dashboard-panel {
            background-color: #1E1E1E; /* Slightly lighter card background */
            border: 1px solid #333333; /* Dark gray border */
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            transition: box-shadow 0.3s;
        }

        /* Primary Button Style */
        .primary-btn {
            background-color: #00BFFF;
            color: #121212; /* Dark text on bright button */
            font-weight: 700;
            transition: background-color 0.2s, transform 0.1s;
        }
        .primary-btn:hover {
            background-color: #00A3D9;
            transform: translateY(-1px);
        }

        /* Input/Form Element Styling */
        .input-dark {
            background-color: #2D2D2D; /* Darker input field */
            border: 1px solid #555555;
            color: #F8FAFC;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .input-dark:focus {
            border-color: #00BFFF;
            box-shadow: 0 0 0 2px rgba(0, 191, 255, 0.5);
        }

        /* Tab Navigation Bar */
        .tab-btn {
            @apply px-4 py-3 font-semibold text-gray-400 transition duration-300 relative overflow-hidden;
        }
        .tab-btn.active {
            @apply text-white;
        }
        /* Active Tab Underline Effect */
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #00BFFF; /* Neon Blue Accent */
            border-radius: 2px 2px 0 0;
        }
    </style>
</head>
<body>

<div id="app-container" class="min-h-screen">

    <main class="max-w-7xl mx-auto p-6 lg:p-10 grid grid-cols-1 lg:grid-cols-3 gap-10">
        
        <section id="link-editor-view" class="lg:col-span-2 dashboard-panel p-8 min-h-[85vh] hidden">
            
            <div class="flex border-b border-gray-700 mb-8 -mx-8 px-8">
                <button id="tab-profile" class="tab-btn active" onclick="showTab('profile')">Profile</button>
                <button id="tab-links" class="tab-btn" onclick="showTab('links')">Links Manager</button>
                <button id="tab-design" class="tab-btn" onclick="showTab('design')">Design</button>
            </div>

            <div id="tab-content-profile" class="tab-content space-y-8">
                <h3 class="text-2xl font-bold neon-blue">Edit Profile</h3>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Display Name</label>
                        <input type="text" id="display-name-input" placeholder="Your Name or Brand" class="w-full input-dark">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Bio (Max 100 characters)</label>
                        <textarea id="bio-input" placeholder="Tell people about yourself..." class="w-full input-dark h-24 resize-none"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Profile Image URL</label>
                        <input type="url" id="profile-image-input" placeholder="URL ending in .jpg/.png" class="w-full input-dark">
                    </div>
                </div>
                
                <button onclick="updateProfileDetails()" class="primary-btn w-full py-3 px-8 rounded-lg shadow-xl">
                    ðŸ’¾ Save Profile Changes
                </button>
            </div>

            <div id="tab-content-links" class="tab-content hidden space-y-8">
                <h3 class="text-2xl font-bold neon-blue">Manage Links</h3>
                
                <div class="p-5 rounded-lg border border-[#333333] bg-[#2A2A2A] space-y-4">
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                        <input type="text" id="new-link-title" placeholder="Link Title" class="w-full sm:w-1/3 input-dark">
                        <input type="url" id="new-link-url" placeholder="URL (e.g., https://example.com)" class="w-full sm:w-2/3 input-dark">
                    </div>
                    <button onclick="addLink()" class="primary-btn w-full py-3 rounded-lg shadow-xl">
                        + Add New Link
                    </button>
                </div>
                
                <div id="links-list" class="space-y-4">
                    <p class="text-gray-500 text-center p-8">No links yet. Add one above!</p>
                </div>
            </div>
            
            <div id="tab-content-design" class="tab-content hidden space-y-8">
                <h3 class="text-2xl font-bold neon-blue">Design Customization</h3>
                
                <div class="p-5 rounded-lg border border-[#333333] bg-[#2A2A2A]">
                    <label class="block text-sm font-medium text-gray-400 mb-2">Select Profile Template</label>
                    <select id="template-select" class="w-full max-w-sm input-dark">
                        <option value="vibrant">Vibrant (Indigo/Pink)</option>
                        <option value="clean">Clean Minimal</option>
                        <option value="dark">Dark Mode Classic</option>
                    </select>
                </div>
                
                <button onclick="updateDesign()" class="primary-btn w-full max-w-sm py-3 rounded-lg shadow-xl">
                    ðŸŽ¨ Apply Theme
                </button>
            </div>

        </section>


        <section class="lg:col-span-1 space-y-6">
            
            <div class="dashboard-panel p-6 space-y-4">
                <div class="flex items-center space-x-3 border-b border-gray-700 pb-4">
                    <img src="https://raw.githubusercontent.com/frthetrash/frthetrash.github.io/refs/heads/main/png.png" 
                         alt="LinkShare Logo" class="w-8 h-8 rounded-full border border-gray-500">
                    <h2 class="text-xl font-bold">LinkShare</h2>
                </div>
                
                <p class="text-gray-400 text-sm">
                    Logged in as: <span id="profile-name-display" class="font-medium text-white"></span>
                </p>

                <button onclick="copyProfileLink()" class="w-full py-3 rounded-lg text-sm text-white font-medium bg-green-600 hover:bg-green-700 transition duration-300 shadow-md">
                    ðŸ”— Copy Profile Link
                </button>
                
                <button onclick="handleLogout()" class="w-full py-3 rounded-lg text-sm text-gray-400 font-medium bg-[#2A2A2A] hover:bg-[#333333] transition duration-300 border border-[#333333]">
                    Log Out
                </button>
            </div>

            <div class="dashboard-panel p-6 space-y-3">
                <h4 class="text-lg font-bold neon-blue">ðŸ’¡ Quick Tips</h4>
                <ul class="list-disc list-inside text-sm text-gray-400 space-y-1">
                    <li>Username is **permanent**.</li>
                    <li>Links must include `https://`.</li>
                    <li>Profile updates **instantly** on your public page.</li>
                </ul>
            </div>
        </section>
        
        <div id="initial-setup-view" class="absolute inset-0 z-50 bg-[#121212]/95 backdrop-blur-md flex items-center justify-center p-8 hidden">
            <div class="dashboard-panel w-full max-w-xl text-center p-12 shadow-2xl">
                <h2 class="text-4xl font-extrabold neon-blue mb-4">Final Setup</h2>
                <p class="text-xl text-gray-300 mb-10">Choose your **permanent** username.</p>
                
                <div id="setup-success-message" class="bg-green-800/70 text-green-300 p-4 rounded-lg text-lg mb-6 mx-auto hidden transition duration-500 ease-in-out">
                    </div>

                <div id="setup-username-container" class="mb-6 mx-auto">
                    <input type="text" id="setup-username" placeholder="CHOOSE PERMANENT USERNAME" 
                           class="w-full input-dark text-center text-lg"
                           maxlength="20">
                    <p class="text-sm text-gray-500 mt-2">Your link: linkshare.com/<span id="username-preview" class="neon-blue font-mono">username</span>. Cannot be changed.</p>
                </div>
                
                <input type="text" id="setup-display-name" placeholder="SET DISPLAY NAME (e.g., Jane Doe)" 
                       class="w-full input-dark text-center text-lg mx-auto mb-8">
                
                <button onclick="updateDisplayNameFromSetup()" id="setup-next-button" 
                        class="primary-btn w-full py-4 rounded-lg shadow-xl disabled:opacity-50">
                    ðŸš€ Finish Setup
                </button>

                <div id="setup-error-message" class="text-red-400 text-sm mt-4"></div>
            </div>
        </div>

    </main>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script src="./js/firebase-config.js"></script>
<script src="./js/auth.js"></script>
<script src="./js/dashboard-editor.js"></script>

<script>
    // --- UI/Tab Management & Setup Logic ---
    const linkEditorView = document.getElementById('link-editor-view');
    const initialSetupView = document.getElementById('initial-setup-view');

    // Function to show the selected tab content
    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(`tab-content-${tabId}`).classList.remove('hidden');
        
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${tabId}`).classList.add('active');
    }

    // Function to reload the live preview iframe (removed, but kept for compatibility)
    function reloadPreview() {
        // Function now empty as preview is removed, but required by dashboard-editor.js
    }

    // Function to copy the profile link
    function copyProfileLink() {
        if (!window.userProfile || !window.userProfile.username) {
            alert("Please complete the setup first to get your permanent profile link!");
            return;
        }
        const profileUrl = `${window.location.origin}/profile.html?username=${window.userProfile.username}`;
        navigator.clipboard.writeText(profileUrl).then(() => {
            alert(`Profile link copied! Share this link: ${profileUrl}`);
        });
    }

    // Function to reveal content after auth state check
    function revealContent() {
        document.body.style.opacity = 1;
    }
    
    // --- START OF NEW/CORRECTED SETUP INTERCEPTION LOGIC ---
    const setupNameInput = document.getElementById('setup-display-name');
    const setupUsernameInput = document.getElementById('setup-username');
    const setupUsernameContainer = document.getElementById('setup-username-container');
    const setupButton = document.getElementById('setup-next-button');
    const usernamePreviewEl = document.getElementById('username-preview');
    const errorMessageEl = document.getElementById('setup-error-message');
    const successMessageEl = document.getElementById('setup-success-message');

    // Button enabling logic
    const checkSetupInputs = () => {
        const displayName = setupNameInput.value.trim();
        const username = setupUsernameInput.value.trim();
        const isUsernameRequired = initialSetupView.classList.contains('hidden') ? false : true; 
        
        setupButton.disabled = displayName.length < 3 || (isUsernameRequired && username.length < 3);
        errorMessageEl.textContent = '';
    };

    setupNameInput.addEventListener('input', checkSetupInputs);
    setupUsernameInput.addEventListener('input', () => {
        const username = setupUsernameInput.value.trim().toLowerCase().replace(/[^a-z0-9_-]/g, '');
        setupUsernameInput.value = username; 
        usernamePreviewEl.textContent = username || 'username';
        checkSetupInputs();
    });
    
    // Override the dashboard-editor function to implement the UI switch
    const originalFetchUserData = window.fetchUserData; 
    window.fetchUserData = (uid) => {
        originalFetchUserData(uid);

        setTimeout(() => {
            const isFirstTimeSetup = window.userProfile && !window.userProfile.username;

            if (isFirstTimeSetup) {
                // Show the full-screen modal intercept
                initialSetupView.classList.remove('hidden');
                linkEditorView.classList.add('hidden');
                setupUsernameInput.value = ''; 
                setupNameInput.value = window.userProfile.displayName || '';
                checkSetupInputs();
            } else {
                // Hide intercept, show editor
                initialSetupView.classList.add('hidden');
                linkEditorView.classList.remove('hidden');
            }
            revealContent();
        }, 100); 
    };

    // The CRITICAL logic for saving the permanent username and display name
    window.updateDisplayNameFromSetup = async () => {
        setupButton.disabled = true;
        errorMessageEl.textContent = '';
        successMessageEl.classList.add('hidden');
        
        const displayName = setupNameInput.value.trim();
        let updates = { displayName: displayName };
        let newUsername = null;

        // --- FIX 1: Ensure currentUserUid is available ---
        if (!window.currentUserUid) {
            const firebaseUser = auth.currentUser;
            if (firebaseUser) {
                window.currentUserUid = firebaseUser.uid;
            }
        }
        
        if (!window.currentUserUid) {
            errorMessageEl.textContent = 'Authentication error. Please refresh and log in.';
            setupButton.disabled = false;
            return; 
        }
        // --- END FIX 1 ---
        
        if (displayName.length < 3) {
            errorMessageEl.textContent = 'Display name must be at least 3 characters.';
            setupButton.disabled = false;
            return;
        }
        

        if (!window.userProfile.username) {
            newUsername = setupUsernameInput.value.toLowerCase().trim();
            
            if (newUsername.length < 3) {
                errorMessageEl.textContent = 'Username must be at least 3 characters.';
                setupButton.disabled = false;
                return;
            }
            if (!/^[a-z0-9_-]+$/.test(newUsername)) {
                errorMessageEl.textContent = 'Username can only contain lowercase letters, numbers, hyphen (-) and underscore (_).';
                setupButton.disabled = false;
                return;
            }

            try {
                const userQuery = await db.collection('users').where('username', '==', newUsername).limit(1).get();
                if (!userQuery.empty) {
                    errorMessageEl.textContent = 'That username is already taken. Try another.';
                    setupButton.disabled = false;
                    return;
                }
            } catch(e) {
                console.error("Username Check Failed:", e);
                errorMessageEl.textContent = 'Could not check username uniqueness. Try again.';
                setupButton.disabled = false;
                return;
            }

            updates.username = newUsername;
            updates.isUsernameSet = true;
        }


        try {
            await db.collection('users').doc(window.currentUserUid).set(updates, { merge: true });
            
            window.userProfile.displayName = displayName; 
            if (newUsername) {
                window.userProfile.username = newUsername;
            }

            const profileUrl = `${window.location.origin}/profile.html?username=${window.userProfile.username}`;
            
            successMessageEl.innerHTML = `
                ðŸŽ‰ **Setup Complete!** Your public link is ready to share.
                <br>
                <a href="${profileUrl}" target="_blank" class="text-white underline font-semibold mt-1 block hover:text-[#00BFFF] transition">
                    ${profileUrl}
                </a>
            `;
            successMessageEl.classList.remove('hidden');

            setTimeout(() => {
                window.fetchUserData(window.currentUserUid); 
            }, 3000);
            
        } catch (e) {
            console.error("Setup update failed with Firestore error:", e);
            errorMessageEl.textContent = 'Failed to save setup. Please check the console for details.';
            setupButton.disabled = false;
        }
    };
</script>

</body>
</html>
